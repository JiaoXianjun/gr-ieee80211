# gr-ieee80211
- GNU Radio IEEE 802.11a/g/n/ac transmitter and receiver.
- Supports upto 2x2 SU-MIMO and MU-MIMO.
- Main branch is GNU Radio 3.10 version with CUDA, CUDA Part NOT STABLE YET!
- For the CPU version without CUDA, please checkout to maint-3.10-cpu.

# Receiver Design
- STF gives trigger of LTF starting point and the CFO updating point by a byte stream.
- LTF if triggered by STF, it runs auto correlation to find fine start timing, give the starting index and accurate CFO
- LTF estimates channel and passes it to signal block.
- Signal block demod and decode signal field, further check HT signal and VHT signal A information and check correctness.
- Demod demodulates OFDM and get LLR of bits.
- Decode uses soft viterbi

# Transmitter Design
- Transmitter encode: generate signal field bits
- Transmitter encode: encode psdu bits: scramble, bcc, stream parser, and interleave
- Transmitter modulation: generate training fields
- Transmitter modulation: modulate signal field with OFDM/QAM
- Transmitter modulation: modulate psdu with OFDM/QAM

Issue in TX
------------
![alt text](https://github.com/cloud9477/gr-ieee80211/blob/main/figRmMisalign.png?raw=true)
- As shown in the figure, when use USRP B210 with 2 TX channels to tranmsmit an MIMO packet, it shows the misalignment between the two spatial streams.
- This is solved by adding the "tx_time" tag to the two streams in the block modulation
- To use the uhd lib, in CMake, find the library and link it.
- At the same time, the Sync select box in USRP Sink changes to PC Clock on Next PPS
# How to use
- MAC layer packets are generated by python.
- MU-MIMO: channel estimation, V and Q matrix are also processed in python. Q is then passed to GNU Radio for later MU-MIMO transmissions.

# Installation
- Install GNU Radio 3.10 dev according to the GNU Radio offical website
- Install UHD
- Install liborc
- Copy and install gr-ieee80211 module for GNU Radio
- I usually put the GNU Radio modules in a folder named "sdr" in home folder, if you use a different path, please correct the paths in the codes. For example the python tools.
- Ubuntu 20.04 GNU Radio CPU Version
```console
sdr@sdr:~$ sudo apt-get install gnuradio-dev uhd-host libuhd-dev cmake build-essential
sdr@sdr:~$ sudo cp /lib/uhd/utils/uhd-usrp.rules /etc/udev/rules.d/
sdr@sdr:~$ sudo udevadm control --reload-rules
sdr@sdr:~$ sudo udevadm trigger
sdr@sdr:~$ sudo uhd_images_downloader
sdr@sdr:~$ sudo apt-get install liborc-0.4-dev
sdr@sdr:~$ mkdir sdr
sdr@sdr:~$ cd sdr
sdr@sdr:~$ git clone https://github.com/cloud9477/gr-ieee80211.git
sdr@sdr:~$ cd gr-ieee80211/
sdr@sdr:~$ git checkout maint-3.10-cpu
sdr@sdr:~$ mkdir build
sdr@sdr:~$ cd build
sdr@sdr:~$ cmake ../
sdr@sdr:~$ make
sdr@sdr:~$ sudo make install
sdr@sdr:~$ sudo ldconfig
```


- Ubuntu 22.04 GNU Radio
- When install the OS, I didn't click the "Install third party drivers ...".
```console
sdr@sdr:~$ sudo apt-get install gnuradio-dev uhd-host libuhd-dev cmake build-essential
sdr@sdr:~$ sudo cp /lib/uhd/utils/uhd-usrp.rules /etc/udev/rules.d/
sdr@sdr:~$ sudo udevadm control --reload-rules
sdr@sdr:~$ sudo udevadm trigger
sdr@sdr:~$ sudo uhd_images_downloader
```
- Ubuntu 22.04 CUDA (2022-12-9), the toolkit will also install the driver. The tool kit version here is 12.0, it matches the driver version 525.
- nvidia-smi to test the driver and nvcc to test the cuda tool kit.
```console
sdr@sdr:~$ wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-ubuntu1804.pin
sdr@sdr:~$ sudo mv cuda-ubuntu1804.pin /etc/apt/preferences.d/cuda-repository-pin-600
sdr@sdr:~$ wget https://developer.download.nvidia.com/compute/cuda/12.0.0/local_installers/cuda-repo-ubuntu1804-12-0-local_12.0.0-525.60.13-1_amd64.deb
sdr@sdr:~$ sudo dpkg -i cuda-repo-ubuntu1804-12-0-local_12.0.0-525.60.13-1_amd64.deb
sdr@sdr:~$ sudo cp /var/cuda-repo-ubuntu1804-12-0-local/cuda-*-keyring.gpg /usr/share/keyrings/
sdr@sdr:~$ sudo apt-get update
sdr@sdr:~$ sudo apt-get -y install cuda
sdr@sdr:~$ sudo reboot
sdr@sdr:~$ nvidia-smi
```
- Add the PATH "/usr/local/cuda-12.0/bin" to file "/etc/environment".
- In "/etc/ld.so.conf.d", create a new file (e.g. cloud_cuda.conf), and put the "/usr/local/cuda-12.0/lib64" in it for x64 system.
- That is to add the path to the system permanently, and then reboot.
- The following part could be used to test the driver and CUDA:
```console
sdr@sdr:~$ nvcc --version
sdr@sdr:~$ cd sdr
sdr@sdr:~$ git clone https://github.com/NVIDIA/cuda-samples.git
sdr@sdr:~$ cd cuda-samples/Samples/1_Utilities/deviceQuery
sdr@sdr:~$ make
sdr@sdr:~$ cd Samples/1_Utilities/deviceQuery
sdr@sdr:~$ ./deviceQuery
```
- If the make reports error, mostly it is because that the version is not correct, the cuda tool kit doesn't match the driver, or even other issues. I have met many.
- And finally install the gr-ieee80211 module:
```console
sdr@sdr:~$ cd sdr
sdr@sdr:~$ git clone https://github.com/cloud9477/gr-ieee80211.git
sdr@sdr:~$ cd gr-ieee80211/
sdr@sdr:~$ mkdir build
sdr@sdr:~$ cd build
sdr@sdr:~$ cmake ../
sdr@sdr:~$ make
sdr@sdr:~$ sudo make install
sdr@sdr:~$ sudo ldconfig
```

# CUDA Related Info

Some hardware tested by author.

RTX 3070
--------
- Zotac 3070 Gaming
- Device name: NVIDIA GeForce RTX 3070
- SM Number: 46
- SM Max Thread Number: 1536
- Block Share Mem Size: 49152
- Block Max Thread Number: 1024
- Memory Clock Rate (KHz): 7001000
- Memory Bus Width (bits): 256
- Peak Memory Bandwidth (GB/s): 448.064000

GTX 1070
--------
- MSI 1070 ARMOR
- Device name: NVIDIA GeForce GTX 1070
- SM Number: 15
- SM Max Thread Number: 2048
- Block Share Mem Size: 49152
- Block Max Thread Number: 1024
- Memory Clock Rate (KHz): 4004000
- Memory Bus Width (bits): 256
- Peak Memory Bandwidth (GB/s): 256.256000

# Some Test Info

Intel 11700 200 packet siso
---------------
- trigger procd samp: 57864056, used time: 58103us, avg 995.888 samp/us
- sync procd samp: 57864008, used time: 226609us, avg 255.347 samp/us
- signal procd samp: 57864184, used time: 299814us, avg 193 samp/us
- demod procd samp: 7215040, used time: 274275us, avg 26.3059 samp/us
- decode procd llr: 6693152, used time: 6288302us, avg 1.06438 llr/us

Use watch and nvidia-smi to minitor GPU

```console
sdr@sdr:~$ watch -n 0.1 nvidia-smi
```

Use top to record CPU usage
---------------
- The -1 is usage by core, -d is interval, -n is sample number, -b is logging.
```console
sdr@sdr:~$ top -1 -d 0.1 -n 200 -b > toplog.txt
```
